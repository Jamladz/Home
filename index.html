<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TonQash - Game Platform</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0078ff;
      --primary-dark: #005fcc;
      --secondary: #1c2e4a;
      --background: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --card-border: rgba(51, 65, 85, 0.5);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --ton-gradient: linear-gradient(135deg, #0088cc, #3f8ae0);
      --tqh-gradient: linear-gradient(135deg, #1e5799, #0078ff);
      --surface: rgba(30, 41, 59, 0.9);
      --glass: rgba(255, 255, 255, 0.05);
      --referral-color: #9c27b0;
      --ad-color: #ff5722;
      --game-1: #6366f1;
      --game-2: #8b5cf6;
      --game-3: #a855f7;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    body {
      background: var(--background);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(30, 41, 59, 0.5) 0%, transparent 30%),
        radial-gradient(circle at 90% 80%, rgba(0, 120, 255, 0.15) 0%, transparent 30%),
        linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px 16px 100px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0 25px;
      position: relative;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }
    
    .logo img {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      object-fit: cover;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .logo h1 {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      background: linear-gradient(to right, var(--text-primary), #a5d8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(0, 120, 255, 0.3);
    }
    
    .connect-btn {
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      border: none;
      border-radius: 18px;
      padding: 12px 22px;
      color: white;
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 120, 255, 0.3);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .connect-btn.connected {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }
    
    .page {
      display: none;
      animation: fadeIn 0.5s ease forwards;
    }
    
    .page.active {
      display: block;
    }
    
    .total-balance {
      background: var(--card-bg);
      border-radius: 28px;
      padding: 28px;
      margin-bottom: 24px;
      border: 1px solid var(--card-border);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(12px);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .total-label {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .total-amount {
      font-size: 3rem;
      font-weight: 800;
      letter-spacing: -1.5px;
      margin-bottom: 4px;
      background: linear-gradient(to right, #ffffff, #c7d2fe);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(0, 120, 255, 0.3);
    }
    
    .total-subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .tokens-section {
      background: var(--card-bg);
      border-radius: 28px;
      padding: 0;
      margin-bottom: 24px;
      border: 1px solid var(--card-border);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      backdrop-filter: blur(12px);
    }
    
    .section-header {
      padding: 22px 24px;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .section-header h2 {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }
    
    .token-list {
      list-style: none;
    }
    
    .token-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 22px 24px;
      border-bottom: 1px solid var(--card-border);
      position: relative;
    }
    
    .token-item:last-child {
      border-bottom: none;
    }
    
    .token-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .token-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: bold;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .ton-icon {
      background-color: #0088cc;
      background-image: url('https://ton.org/download/ton_symbol.png');
    }
    
    .tqh-icon {
      background-color: #1e5799;
      background-image: url('https://i.suar.me/vpO26/l');
    }
    
    .token-details h3 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .token-details p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .token-balance {
      text-align: right;
    }
    
    .token-balance .amount {
      font-size: 1.3rem;
      font-weight: 800;
      margin-bottom: 4px;
    }
    
    .token-balance .value {
      font-size: 0.95rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .swap-section {
      background: var(--card-bg);
      border-radius: 28px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--card-border);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
      text-align: center;
    }
    
    .swap-header {
      font-size: 1.3rem;
      margin-bottom: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .swap-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .swap-input-group {
      position: relative;
    }
    
    .swap-input {
      width: 100%;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .swap-label {
      position: absolute;
      top: -10px;
      left: 15px;
      background: var(--card-bg);
      padding: 0 8px;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .swap-button {
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      border: none;
      border-radius: 16px;
      padding: 16px;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 120, 255, 0.3);
      margin-top: 10px;
    }
    
    .swap-button:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
    }
    
    /* Compact Tasks Section */
    .tasks-container {
      display: grid;
      gap: 16px;
    }
    
    .task-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid var(--card-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .task-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .task-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(0, 120, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--primary);
    }
    
    .task-title {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .task-description {
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.5;
      font-size: 0.9rem;
    }
    
    .task-reward {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .reward-icon {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: var(--tqh-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
    }
    
    .profile-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--ton-gradient);
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
      color: white;
    }
    
    .profile-name {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }
    
    .profile-wallet {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-bottom: 30px;
    }
    
    .profile-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .profile-stat {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--card-border);
    }
    
    .referral-section {
      background: var(--card-bg);
      border-radius: 28px;
      padding: 0;
      margin-bottom: 24px;
      border: 1px solid var(--card-border);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      backdrop-filter: blur(12px);
    }
    
    .referral-content {
      padding: 22px 24px;
    }
    
    .referral-description {
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .referral-link-container {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .referral-link {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 16px 20px;
      color: var(--text-primary);
      font-size: 0.95rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .copy-btn {
      background: var(--primary);
      border: none;
      border-radius: 16px;
      padding: 16px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
    }
    
    .copy-btn:hover {
      background: var(--primary-dark);
    }
    
    .copy-success {
      text-align: center;
      color: var(--success);
      font-weight: 500;
      height: 20px;
      margin-top: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .copy-success.show {
      opacity: 1;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 480px;
      margin: 0 auto;
      background: var(--surface);
      backdrop-filter: blur(25px);
      display: flex;
      justify-content: space-around;
      padding: 18px 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      z-index: 100;
      box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.4);
      border-radius: 30px 30px 0 0;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.8rem;
      transition: all 0.3s ease;
      padding: 10px 20px;
      border-radius: 20px;
      position: relative;
    }
    
    .nav-item::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .nav-item.active {
      color: var(--primary);
      background: rgba(0, 120, 255, 0.15);
    }
    
    .nav-item.active::after {
      width: 30px;
    }
    
    .nav-item i {
      font-size: 1.4rem;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.97);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: 30px;
      width: 90%;
      max-width: 400px;
      padding: 30px;
      text-align: center;
      transform: translateY(30px);
      transition: transform 0.3s ease;
      border: 1px solid var(--card-border);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      font-size: 1.6rem;
      margin-bottom: 10px;
    }
    
    .modal-header p {
      color: var(--text-secondary);
    }
    
    #ton-connect {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      position: absolute;
      top: 25px;
      right: 25px;
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Withdrawal Section */
    .withdrawal-section {
      background: var(--card-bg);
      border-radius: 28px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--card-border);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
      text-align: center;
    }
    
    .withdrawal-header {
      font-size: 1.4rem;
      margin-bottom: 15px;
      font-weight: 700;
    }
    
    .withdrawal-info {
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .withdrawal-min {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 12px;
      color: var(--danger);
    }
    
    /* Airdrop Button */
    .airdrop-section {
      background: var(--card-bg);
      border-radius: 28px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--card-border);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
      text-align: center;
    }
    
    .airdrop-header {
      font-size: 1.4rem;
      margin-bottom: 15px;
      font-weight: 700;
    }
    
    .airdrop-info {
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    /* Referral Earnings */
    .referral-earnings {
      display: flex;
      justify-content: space-between;
      background: rgba(156, 39, 176, 0.1);
      padding: 15px;
      border-radius: 16px;
      margin: 15px 0;
    }
    
    .referral-earnings span {
      color: var(--referral-color);
      font-weight: 600;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 12px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 2000;
      transition: opacity 0.3s ease;
    }
    
    .notification.success {
      color: var(--success);
      border-left: 4px solid var(--success);
    }
    
    .notification.error {
      color: var(--danger);
      border-left: 4px solid var(--danger);
    }
    
    .notification.warning {
      color: var(--warning);
      border-left: 4px solid var(--warning);
    }
    
    .notification.info {
      color: var(--primary);
      border-left: 4px solid var(--primary);
    }
    
    .notification.ad {
      color: var(--ad-color);
      border-left: 4px solid var(--ad-color);
    }
    
    .notification i {
      font-size: 1.2rem;
    }
    
    /* Game Section Styles */
    .game-container {
      display: grid;
      gap: 20px;
    }
    
    .game-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid var(--card-border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .game-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .game-image {
      width: 100%;
      height: 200px;
      border-radius: 16px;
      background-size: cover;
      background-position: center;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .game-progress {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }
    
    .game-progress-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .game-stats {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      color: var(--text-secondary);
    }
    
    .game-reward {
      font-size: 1.4rem;
      font-weight: 700;
      text-align: center;
      margin: 15px 0;
    }
    
    .game-description {
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .game-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    .game-play-btn {
      background: linear-gradient(135deg, var(--game-1), var(--game-2));
      border: none;
      border-radius: 16px;
      padding: 14px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }
    
    .game-play-btn:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
    }
    
    .game-play-btn.completed {
      background: var(--success);
    }
    
    /* Game Canvas */
    #game-canvas-container, #game2-canvas-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0f172a;
      z-index: 2000;
      display: none;
    }
    
    #game-canvas-container.active, #game2-canvas-container.active {
      display: block;
    }
    
    #game-canvas, #game2-canvas {
      width: 100%;
      height: 100%;
    }
    
    .game-ui {
      position: fixed;
      top: 20px;
      left: 20px;
      right: 20px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      margin: 8px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 2001;
    }
    
    .ui-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }
    
    .ui-icon {
      width: 20px;
      height: 20px;
      filter: brightness(1.5);
    }
    
    .game-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(16px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 2002;
    }
    
    .screen-heading {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(45deg, var(--game-1), var(--game-3));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 1.5rem;
    }
    
    .game-button {
      background: linear-gradient(45deg, var(--game-1), var(--game-2));
      border: none;
      color: white;
      padding: 14px 28px;
      font-size: 1.1rem;
      font-weight: 500;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: min(80vw, 280px);
      margin: 8px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .game-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
    }
    
    .button-danger {
      background: linear-gradient(45deg, var(--danger), #dc2626);
    }
    
    .button-success {
      background: linear-gradient(45deg, var(--success), #16a34a);
    }
    
    .user-profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(8px);
      border-radius: 16px;
      margin-bottom: 2rem;
      width: min(90%, 300px);
    }
    
    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid var(--game-1);
      object-fit: cover;
    }
    
    .user-name {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 12px;
      max-width: 250px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
      100% { transform: translateY(0px); }
    }
    
    .floating {
      animation: float 3s ease-in-out infinite;
    }
    
    .game-effect {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 2003;
    }
    
    .freeze-effect {
      background: linear-gradient(
          rgba(178, 235, 242, 0.1),
          rgba(178, 235, 242, 0.2)
      );
      animation: iceShimmer 2s infinite;
      overflow: hidden;
    }
    
    .bomb-effect {
      background: rgba(239, 68, 68, 0.2);
      animation: bombShake 0.4s;
    }
    
    @keyframes iceShimmer {
      0% { opacity: 0.3; }
      50% { opacity: 0.6; }
      100% { opacity: 0.3; }
    }
    
    @keyframes bombShake { 
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(-5px, 5px); }
      50% { transform: translate(5px, -5px); }
      75% { transform: translate(-5px, -5px); }
    }
    
    @keyframes fall {
      to {
          transform: translateY(100vh);
      }
    }
    
    @media (max-width: 480px) {
      .total-amount {
        font-size: 2.5rem;
      }
      
      .token-item {
        padding: 18px 20px;
      }
      
      .referral-link-container {
        flex-direction: column;
      }
      
      .copy-btn {
        width: 100%;
      }
    }
    
    /* Loading animation */
    .loading-dots {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 20px;
    }
    
    .loading-dots div {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      animation-timing-function: cubic-bezier(0, 1, 1, 0);
    }
    
    .loading-dots div:nth-child(1) {
      left: 8px;
      animation: loading-dots1 0.6s infinite;
    }
    
    .loading-dots div:nth-child(2) {
      left: 8px;
      animation: loading-dots2 0.6s infinite;
    }
    
    .loading-dots div:nth-child(3) {
      left: 32px;
      animation: loading-dots2 0.6s infinite;
    }
    
    .loading-dots div:nth-child(4) {
      left: 56px;
      animation: loading-dots3 0.6s infinite;
    }
    
    @keyframes loading-dots1 {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }
    
    @keyframes loading-dots3 {
      0% { transform: scale(1); }
      100% { transform: scale(0); }
    }
    
    @keyframes loading-dots2 {
      0% { transform: translate(0, 0); }
      100% { transform: translate(24px, 0); }
    }

    .bonus-badge {
      background: var(--success);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 5px;
    }

    .tqh-info {
      background: rgba(30, 90, 153, 0.2);
      border-radius: 16px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
      color: var(--text-primary);
      border: 1px solid rgba(0, 120, 255, 0.3);
    }
    
    /* Hourglass animation */
    .hourglass-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 40px;
    }
    
    .hourglass {
      display: inline-block;
      position: relative;
      width: 40px;
      height: 40px;
    }
    
    .hourglass:after {
      content: " ";
      display: block;
      border-radius: 50%;
      width: 0;
      height: 0;
      margin: 8px;
      box-sizing: border-box;
      border: 15px solid #0078ff;
      border-color: #0078ff transparent #0078ff transparent;
      animation: hourglass 1.5s infinite;
    }
    
    @keyframes hourglass {
      0% {
        transform: rotate(0);
        animation-timing-function: cubic-bezier(0.55, 0.055, 0.675, 0.19);
      }
      50% {
        transform: rotate(900deg);
        animation-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
      }
      100% {
        transform: rotate(1800deg);
      }
    }
    
    /* Zero TON Modal */
    .zero-ton-modal-content {
      background: var(--card-bg);
      border-radius: 30px;
      width: 90%;
      max-width: 400px;
      padding: 30px;
      text-align: center;
      border: 1px solid var(--card-border);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
      position: relative;
    }
    
    .zero-ton-header {
      margin-bottom: 20px;
    }
    
    .zero-ton-header h2 {
      font-size: 1.6rem;
      margin-bottom: 10px;
      color: var(--primary);
    }
    
    .zero-ton-steps {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
      text-align: left;
    }
    
    .zero-ton-step {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      padding: 12px;
      background: rgba(0, 120, 255, 0.1);
      border-radius: 12px;
    }
    
    .step-icon {
      font-size: 1.5rem;
      color: var(--primary);
      min-width: 30px;
    }
    
    .step-content h3 {
      margin-bottom: 5px;
      color: var(--text-primary);
    }
    
    .step-content p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .dont-show-again {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    /* New badge for bonus */
    .bonus-tag {
      background: var(--success);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      margin-left: 8px;
      font-weight: 600;
    }
    
    /* Welcome Modal */
    .welcome-modal-content {
      background: var(--card-bg);
      border-radius: 30px;
      width: 90%;
      max-width: 400px;
      padding: 30px;
      text-align: center;
      border: 1px solid var(--card-border);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
      position: relative;
    }
    
    .welcome-header {
      margin-bottom: 20px;
    }
    
    .welcome-header h2 {
      font-size: 1.8rem;
      margin-bottom: 10px;
      color: var(--primary);
      background: linear-gradient(to right, #0078ff, #00c6ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .welcome-bonus {
      background: rgba(16, 185, 129, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid var(--success);
    }
    
    .welcome-bonus-amount {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--success);
      margin: 10px 0;
    }
    
    .welcome-icon {
      font-size: 3.5rem;
      color: var(--success);
      margin-bottom: 15px;
    }

    /* Subway Surfers Game Container */
    .subway-game-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 2000;
      display: none;
    }

    .subway-game-container.active {
      display: block;
    }

    .subway-top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background-color: #1a1a1a;
      display: flex;
      align-items: center;
      padding: 0 15px;
      z-index: 2001;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .subway-home-button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.3s;
    }

    .subway-home-button:hover {
      background-color: #45a049;
    }

    .subway-home-button i {
      font-size: 16px;
    }

    .subway-game-frame {
      position: fixed;
      top: 50px;
      left: 0;
      width: 100vw;
      height: calc(100vh - 50px);
      background: #000;
      border: none;
    }

    .subway-game-overlay {
      position: fixed;
      top: 50px;
      left: 0;
      width: 100%;
      height: calc(100% - 50px);
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(16px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 2002;
    }

    .subway-score-display {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      border: 1px solid var(--card-border);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      margin-bottom: 20px;
    }

    .subway-score-value {
      font-size: 3rem;
      font-weight: 800;
      color: var(--success);
      margin: 10px 0;
    }

    .subway-reward-message {
      color: var(--text-secondary);
      margin: 15px 0;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <img src="https://i.suar.me/81MBZ/l" alt="TonQash Logo">
        <h1>TonQash</h1>
      </div>
      <button class="connect-btn" id="connect-button">
        <i class="fas fa-wallet"></i>
        <span id="connect-text">Connect Wallet</span>
      </button>
    </div>
    
    <!-- Home Page -->
    <div class="page active" id="home-page">
      <div class="total-balance">
        <div class="total-label">Total Balance</div>
        <div class="total-amount" id="total-balance">$0.00</div>
        <div class="total-subtitle" id="ton-balance">0.000 TON</div>
      </div>
      
      <div class="tqh-info">
        <p><i class="fas fa-gift"></i> New users get 50 TQH bonus! <span class="bonus-tag">BONUS</span></p>
        <p><i class="fas fa-link"></i> Connect wallet to get 0.5 TON <span class="bonus-tag">+0.5 TON</span></p>
      </div>
      
      <div class="tokens-section">
        <div class="section-header">
          <h2>Tokens</h2>
        </div>
        <ul class="token-list">
          <li class="token-item">
            <div class="token-info">
              <div class="token-icon ton-icon"></div>
              <div class="token-details">
                <h3>Toncoin</h3>
                <p>TON</p>
              </div>
            </div>
            <div class="token-balance">
              <div class="amount" id="ton-amount">0.000</div>
              <div class="value" id="ton-value">$0.00</div>
            </div>
          </li>
          <li class="token-item">
            <div class="token-info">
              <div class="token-icon tqh-icon"></div>
              <div class="token-details">
                <h3>TonQash</h3>
                <p>TQH</p>
              </div>
            </div>
            <div class="token-balance">
              <div class="amount" id="tqh-amount">0.000</div>
              <div class="value" id="tqh-value">$0.00</div>
            </div>
          </li>
        </ul>
      </div>
      
      <div class="swap-section">
        <div class="swap-header">Convert TQH to TON</div>
        <div class="swap-form">
          <div class="swap-input-group">
            <label class="swap-label">You Pay</label>
            <input type="number" class="swap-input" id="tqh-input" placeholder="0.00" min="0" step="0.001">
            <div class="token-info" style="position: absolute; top: 15px; right: 15px;">
              <span class="token-icon tqh-icon" style="width: 30px; height: 30px;"></span>
              <span style="margin-left: 8px; font-weight: 600;">TQH</span>
            </div>
          </div>
          
          <div style="text-align: center; margin: 10px 0;">
            <i class="fas fa-exchange-alt" style="color: var(--primary); font-size: 1.5rem;"></i>
          </div>
          
          <div class="swap-input-group">
            <label class="swap-label">You Receive</label>
            <input type="text" class="swap-input" id="ton-output" placeholder="0.00" readonly>
            <div class="token-info" style="position: absolute; top: 15px; right: 15px;">
              <span class="token-icon ton-icon" style="width: 30px; height: 30px;"></span>
              <span style="margin-left: 8px; font-weight: 600;">TON</span>
            </div>
          </div>
          
          <div style="margin: 10px 0; color: var(--text-secondary);">
            Exchange Rate: 30 TQH = 0.1 TON
          </div>
          
          <button class="swap-button" id="swap-button" disabled>
            Convert Now
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tasks Page -->
    <div class="page" id="tasks-page">
      <div class="tasks-container">
        <div class="task-card">
          <div class="task-header">
            <div class="task-icon">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div class="task-title">Daily Check-in</div>
          </div>
          <div class="task-description">
            Pay 0.07 TON to claim your daily reward of 30 TQH tokens. This reward can be claimed once every 24 hours.
          </div>
          <div class="task-reward">
            <div class="reward-icon">TQH</div>
            <span>+30 TQH</span>
          </div>
          <button class="swap-button" id="daily-task-btn">
            <i class="fas fa-gift"></i> Claim Reward (0.07 TON)
          </button>
          <div id="daily-task-status" style="margin-top: 15px; color: var(--text-secondary); text-align: center; display: none;">
            Reward available in: <span id="daily-countdown">24:00:00</span>
          </div>
        </div>
        
        <div class="task-card">
          <div class="task-header">
            <div class="task-icon">
              <i class="fas fa-ad"></i>
            </div>
            <div class="task-title">Watch Ad</div>
          </div>
          <div class="task-description">
            Watch a short advertisement to earn 10 TQH tokens. You can watch ads multiple times a day.
          </div>
          <div class="task-reward">
            <div class="reward-icon">TQH</div>
            <span>+10 TQH</span>
          </div>
          <button class="swap-button" id="ad-task-btn">
            <i class="fas fa-play-circle"></i> Watch Ad
          </button>
          <div id="ad-timer" style="margin-top: 15px; color: var(--text-secondary); display: none; text-align: center;">
            Next ad available in: <span id="countdown">30</span> seconds
          </div>
        </div>
        
        <!-- Join Telegram Channel Task -->
        <div class="task-card">
          <div class="task-header">
            <div class="task-icon">
              <i class="fab fa-telegram"></i>
            </div>
            <div class="task-title">Join Channel</div>
          </div>
          <div class="task-description">
            Join our official Telegram channel to get 100 TQH tokens. This reward can be claimed only once.
          </div>
          <div class="task-reward">
            <div class="reward-icon">TQH</div>
            <span>+100 TQH</span>
          </div>
          <button class="swap-button" id="telegram-task-btn">
            <i class="fab fa-telegram"></i> Join Channel
          </button>
          <div id="telegram-task-status" style="margin-top: 15px; color: var(--success); text-align: center; display: none;">
            <i class="fas fa-check-circle"></i> Task Completed!
          </div>
        </div>
        
        <!-- Share Referral Link Task -->
        <div class="task-card">
          <div class="task-header">
            <div class="task-icon">
              <i class="fas fa-share-alt"></i>
            </div>
            <div class="task-title">Share Referral</div>
          </div>
          <div class="task-description">
            Share your referral link with friends to earn 50 TQH. Get 10% of their rewards for life!
          </div>
          <div class="task-reward">
            <div class="reward-icon">TQH</div>
            <span>+50 TQH</span>
          </div>
          <button class="swap-button" id="share-referral-btn">
            <i class="fas fa-share-alt"></i> Share Link
          </button>
          <div id="share-referral-status" style="margin-top: 15px; color: var(--success); text-align: center; display: none;">
            <i class="fas fa-check-circle"></i> Task Completed!
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game Page -->
    <div class="page" id="game-page">
      <div class="section-header">
        <h2>Earn TQH by Playing Games</h2>
        <p style="color: var(--text-secondary); font-size: 0.95rem;">Play games and earn TQH tokens for your achievements</p>
      </div>
      
      <div class="game-container">
        <!-- Game 1 - Time Blast -->
        <div class="game-card">
          <div class="game-badge">Popular</div>
          <div class="game-image" style="background-image: url('https://i.suar.me/7a9vr/l')"></div>
          <div class="game-stats">
            <div>Players:</div>
            <div><span id="game1-current">29355</span></div>
          </div>
          <div class="game-reward">+10 TQH per 1000 points</div>
          <div class="game-description">
            Time Blast - Catch falling objects and avoid bombs. Earn TQH tokens for every 1000 points you score!
          </div>
          <button class="game-play-btn" id="game1-btn" data-game="1">
            <i class="fas fa-play-circle"></i> Play Game
          </button>
        </div>
        
        <!-- Game 2 - Subway Surfers -->
        <div class="game-card">
          <div class="game-badge">New</div>
          <div class="game-image" style="background-image: url('https://i.suar.me/1AoG3/l')"></div>
          <div class="game-stats">
            <div>Players:</div>
            <div><span id="game2-current">13789</span></div>
          </div>
          <div class="game-reward">+15 TQH per 5000 points</div>
          <div class="game-description">
            Subway Surfers - Run as far as you can and avoid obstacles. Earn TQH rewards based on your score!
          </div>
          <button class="game-play-btn" id="game2-btn" data-game="2">
            <i class="fas fa-play-circle"></i> Play Game
          </button>
        </div>
        
        <!-- Game 3 -->
        <div class="game-card">
          <div class="game-badge">Coming Soon</div>
          <div class="game-image" style="background-image: url('https://i.suar.me/gPB5w/l')"></div>
          <div class="game-stats">
            <div>Players:</div>
            <div><span id="game3-current">0</span></div>
          </div>
          <div class="game-reward">TBA</div>
          <div class="game-description">
            Token Puzzle - Match tokens to earn rewards. New game coming soon with exciting TQH rewards!
          </div>
          <button class="game-play-btn" id="game3-btn" data-game="3" disabled>
            <i class="fas fa-clock"></i> Coming Soon
          </button>
        </div>
      </div>
    </div>
    
    <!-- Profile Page -->
    <div class="page" id="profile-page">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="profile-name" id="profile-name">Telegram User</div>
        <div class="profile-wallet" id="wallet-address">Not connected</div>
      </div>
      
      <div class="profile-stats">
        <div class="profile-stat">
          <div class="stat-value" id="profile-ton">0.000</div>
          <div class="stat-label">TON</div>
        </div>
        <div class="profile-stat">
          <div class="stat-value" id="profile-tqh">0.000</div>
          <div class="stat-label">TQH</div>
        </div>
      </div>
      
      <!-- Airdrop Section -->
      <div class="airdrop-section">
        <div class="airdrop-header">
          <i class="fas fa-parachute-box"></i> Airdrop
        </div>
        <div class="airdrop-info">
          Participate in our exclusive airdrop events to earn free tokens. Stay tuned for upcoming airdrop opportunities!
        </div>
        <button class="swap-button" id="airdrop-button">
          <i class="fas fa-gift"></i> Check Airdrop
        </button>
      </div>
      
      <div class="withdrawal-section">
        <div class="withdrawal-header">
          <i class="fas fa-money-bill-wave"></i> Withdraw TON
        </div>
        <div class="withdrawal-info">
          Withdraw your TON tokens to your wallet. Minimum withdrawal amount is 70 TON.
        </div>
        <div class="withdrawal-min">
          <i class="fas fa-exclamation-circle"></i>
          Minimum: 70 TON ($217.00)
        </div>
        <button class="swap-button" id="withdraw-button" disabled>
          <i class="fas fa-paper-plane"></i> Withdraw TON
        </button>
      </div>
      
      <div class="referral-section">
        <div class="section-header">
          <h2>Referral Program</h2>
        </div>
        <div class="referral-content">
          <div class="referral-description">
            Invite friends to join TonQash using your unique referral link. 
            Earn <strong>10%</strong> of their rewards for life! Share your link and grow your earnings.
          </div>
          
          <div class="referral-earnings">
            <div>Total Referrals:</div>
            <div><span id="referral-count">Hidden</span></div>
          </div>
          
          <div class="referral-earnings">
            <div>Referral Earnings:</div>
            <div><span id="referral-earnings">Hidden</span> TQH</div>
          </div>
          
          <div class="referral-link-container">
            <div class="referral-link" id="referral-link">https://t.me/TonQashBot?start=ref_username</div>
            <button class="copy-btn" id="copy-referral-btn">
              <i class="fas fa-copy"></i> Copy
            </button>
          </div>
          <div class="copy-success" id="copy-success">
            <i class="fas fa-check-circle"></i> Link copied to clipboard!
          </div>
        </div>
      </div>
      
      <div class="tokens-section">
        <div class="section-header">
          <h2>Activity</h2>
        </div>
        <div style="padding: 20px; text-align: center;">
          <i class="fas fa-history" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5; margin-bottom: 15px;"></i>
          <p style="color: var(--text-secondary);">No activity yet</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Game Canvas Container for Time Blast -->
  <div id="game-canvas-container">
    <div class="game-ui">
      <div class="ui-card">
        <img src="https://play-lh.googleusercontent.com/0dI3JtAn_MZNjVy1njKtdfRWGhriJyILLownK3HY6jlXatw774YRVRrXBftkZfBWSQ" class="ui-icon">
        <span id="game-score">0</span>
      </div>
      <div class="ui-card">
        <img src="https://img.icons8.com/ios-filled/50/clock--v1.png" class="ui-icon">
        <span id="game-time">60</span>s
      </div>
    </div>

    <div id="game-start-screen" class="game-screen">
      <div class="user-profile">
        <div class="profile-top">
          <img id="game-user-avatar" class="user-avatar" src="" alt="Avatar">
        </div>
        <div id="game-user-name" class="user-name"></div>
      </div>
      <h1 class="screen-heading floating">TIME BLAST</h1>
      <div class="ui-card" style="margin-bottom: 2rem;">
        <span>High Score: </span>
        <span id="game-high-score">0</span>
      </div>
      <button class="game-button" id="game-start-button">
        <img src="https://img.icons8.com/ios/50/play--v1.png" class="ui-icon">
        Start Game
      </button>
      <button class="game-button button-danger" id="game-exit-button">
        <img src="https://img.icons8.com/ios/50/exit.png" class="ui-icon">
        Exit Game
      </button>
    </div>

    <div id="game-over-screen" class="game-screen" style="display:none">
      <h1 class="screen-heading">GAME OVER</h1>
      <div class="ui-card" style="margin: 1.5rem 0;">
        <span>Score: </span>
        <span id="game-final-score">0</span>
      </div>
      <div id="game-reward-message" style="margin: 1rem 0; color: var(--success); font-weight: 600;"></div>
      <button class="game-button" id="game-restart-button">
        <img src="https://img.icons8.com/ios/50/restart--v1.png" class="ui-icon">
        Play Again
      </button>
      <button class="game-button button-success" id="game-share-button">
        <img src="https://i.imgur.com/LKjClrQ.png" class="ui-icon">
        Share to Story
      </button>
      <button class="game-button button-danger" id="game-menu-button">
        <img src="https://img.icons8.com/ios/50/home-page.png" class="ui-icon">
        Main Menu
      </button>
    </div>

    <div id="game-freeze-effect" class="game-effect freeze-effect" style="display:none"></div>
    <div id="game-bomb-effect" class="game-effect bomb-effect" style="display:none"></div>
    <canvas id="game-canvas"></canvas>
  </div>
  
  <!-- Subway Surfers Game Container -->
  <div class="subway-game-container" id="subway-game-container">
    <div class="subway-top-bar">
      <button class="subway-home-button" onclick="exitSubwaySurfers()">
        <i class="fas fa-home"></i>
        Home
      </button>
    </div>
    <iframe class="subway-game-frame" id="subway-game-frame" src="about:blank" frameborder="0" allowfullscreen></iframe>
    
    <!-- Game Over Overlay -->
    <div class="subway-game-overlay" id="subway-game-overlay" style="display: none;">
      <div class="subway-score-display">
        <h2 style="margin-bottom: 15px;">Game Completed!</h2>
        <div class="subway-score-value" id="subway-final-score">0</div>
        <div class="subway-reward-message" id="subway-reward-message">Calculating your reward...</div>
      </div>
      <button class="game-button" onclick="restartSubwaySurfers()">
        <i class="fas fa-redo"></i>
        Play Again
      </button>
      <button class="game-button button-success" onclick="shareSubwayScore()">
        <i class="fas fa-share"></i>
        Share Score
      </button>
      <button class="game-button button-danger" onclick="exitSubwaySurfers()">
        <i class="fas fa-home"></i>
        Main Menu
      </button>
    </div>
  </div>
  
  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="#" class="nav-item active" data-page="home-page">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="#" class="nav-item" data-page="tasks-page">
      <i class="fas fa-tasks"></i>
      <span>Tasks</span>
    </a>
    <a href="#" class="nav-item" data-page="game-page">
      <i class="fas fa-gamepad"></i>
      <span>Game</span>
    </a>
    <a href="#" class="nav-item" data-page="profile-page">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </div>
  
  <!-- Connect Modal -->
  <div class="modal" id="connect-modal">
    <div class="modal-content">
      <button class="modal-close" id="modal-close">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-header">
        <h2>Connect Wallet</h2>
        <p>Secure connection to manage your crypto assets</p>
      </div>
      <div id="ton-connect"></div>
      <div id="connected-state">
        <p>Wallet connected:</p>
        <p id="connected-wallet-address"></p>
        <button id="disconnect-button">Disconnect Wallet</button>
      </div>
      <div id="status" class="connect-status">Select a wallet provider</div>
    </div>
  </div>
  
  <!-- Transaction Modal -->
  <div class="modal" id="transaction-modal">
    <div class="modal-content">
      <button class="modal-close" id="tx-modal-close">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-header">
        <h2>Confirm Transaction</h2>
        <p id="tx-description">Payment for daily reward</p>
      </div>
      <div style="text-align: center; margin: 25px 0;">
        <div style="font-size: 3rem; margin-bottom: 20px; color: var(--primary);">
          <i class="fas fa-gift"></i>
        </div>
        <div style="font-size: 1.5rem; margin-bottom: 10px;" id="tx-amount">0 TON</div>
        <div style="color: var(--text-secondary);" id="tx-recipient">To: TonQash Tasks</div>
      </div>
      <button class="swap-button" id="confirm-tx-btn">
        Confirm Payment
      </button>
    </div>
  </div>
  
  <!-- Withdrawal Modal -->
  <div class="modal" id="withdrawal-modal">
    <div class="modal-content">
      <button class="modal-close" id="withdrawal-modal-close">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-header">
        <h2>Withdraw TON</h2>
        <p>Withdraw your TON tokens to your wallet</p>
      </div>
      <div style="text-align: center; margin: 25px 0;">
        <div style="font-size: 3rem; margin-bottom: 20px; color: var(--success);">
          <i class="fas fa-wallet"></i>
        </div>
        <div style="font-size: 1.5rem; margin-bottom: 10px;" id="withdrawal-amount">70 TON</div>
        <div style="color: var(--text-secondary);"> $217.00</div>
      </div>
      <button class="swap-button" id="confirm-withdrawal-btn">
        Confirm Withdrawal
      </button>
    </div>
  </div>
  
  <!-- Processing Modal -->
  <div class="modal" id="processing-modal">
    <div class="modal-content">
      <div class="spinner"></div>
      <div class="modal-header">
        <h2>Processing Transaction</h2>
        <p>Please wait while we process your payment</p>
      </div>
    </div>
  </div>
  
  <!-- Ad Modal -->
  <div class="modal" id="ad-modal">
    <div class="modal-content" id="ad-modal-content">
      <button id="ad-close-btn"></button>
      <div class="ad-progress">
        <div class="ad-progress-bar" id="ad-progress-bar"></div>
      </div>
      <div id="ad-container">
        <div class="ad-loading">
          <div class="spinner"></div>
          <p>Loading advertisement...</p>
        </div>
      </div>
      <div class="ad-message">Watch the ad to earn 10 TQH tokens</div>
    </div>
  </div>
  
  <!-- Zero TON Modal -->
  <div class="modal" id="zero-ton-modal">
    <div class="zero-ton-modal-content">
      <button class="modal-close" id="zero-ton-modal-close">
        <i class="fas fa-times"></i>
      </button>
      <div class="zero-ton-header">
        <h2><i class="fas fa-hourglass-half"></i> Get Your First TON</h2>
        <p>You need TON to transact. Here's how to get started</p>
      </div>
      
      <div class="zero-ton-steps">
        <div class="zero-ton-step">
          <div class="step-icon">
            <i class="fas fa-tasks"></i>
          </div>
          <div class="step-content">
            <h3>Complete Tasks</h3>
            <p>Earn TQH by completing daily tasks and watching ads</p>
          </div>
        </div>
        
        <div class="zero-ton-step">
          <div class="step-icon">
            <i class="fas fa-gamepad"></i>
          </div>
          <div class="step-content">
            <h3>Play Games</h3>
            <p>Earn TQH by playing games and achieving high scores</p>
          </div>
        </div>
        
        <div class="zero-ton-step">
          <div class="step-icon">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <div class="step-content">
            <h3>Convert TQH to TON</h3>
            <p>Swap your earned TQH tokens for TON in the home page</p>
          </div>
        </div>
      </div>
      
      <button class="swap-button" id="go-to-tasks-btn">
        <i class="fas fa-play"></i> Start Earning TQH
      </button>
      
      <div class="dont-show-again">
        <input type="checkbox" id="dont-show">
        <label for="dont-show">Don't show this message again</label>
      </div>
    </div>
  </div>
  
  <!-- Welcome Modal -->
  <div class="modal" id="welcome-modal">
    <div class="welcome-modal-content">
      <div class="welcome-header">
        <h2>Welcome to TonQash!</h2>
        <p>Start your crypto journey with us</p>
      </div>
      
      <div class="welcome-bonus">
        <div class="welcome-icon">
          <i class="fas fa-gift"></i>
        </div>
        <h3>First Login Bonus</h3>
        <div class="welcome-bonus-amount">50 TQH</div>
        <p>Your account has been credited with 50 TQH tokens</p>
      </div>
      
      <p style="margin: 20px 0; color: var(--text-secondary);">
        Connect your wallet to get an additional 0.5 TON bonus
      </p>
      
      <button class="swap-button" id="welcome-connect-btn">
        <i class="fas fa-wallet"></i> Connect Wallet
      </button>
      
      <button class="swap-button" style="background: var(--secondary); margin-top: 15px;" id="welcome-continue-btn">
        Continue Without Wallet
      </button>
    </div>
  </div>
  
  <!-- Airdrop Modal -->
  <div class="modal" id="airdrop-modal">
    <div class="modal-content">
      <button class="modal-close" id="airdrop-modal-close">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-header">
        <h2>Airdrop</h2>
        <p>Exclusive token distribution events</p>
      </div>
      <div style="text-align: center; margin: 25px 0;">
        <div style="font-size: 3rem; margin-bottom: 20px; color: var(--warning);">
          <i class="fas fa-hourglass-half"></i>
        </div>
        <div style="font-size: 1.5rem; margin-bottom: 10px;">Coming Soon</div>
        <div style="color: var(--text-secondary);">We're preparing exciting airdrop events. Stay tuned for updates!</div>
      </div>
      <button class="swap-button" id="airdrop-ok-btn">
        OK
      </button>
    </div>
  </div>
  
  <script>
    // Initialize wallet data with localStorage support
    let walletData = {
      tonBalance: 0,
      tqhBalance: 0,
      lastDailyClaim: null,
      lastAdClaim: null,
      tonPrice: 3.10,
      referralCount: 0,
      referralEarnings: 0,
      referrals: [],
      walletBonusGiven: false,
      firstLoginBonusGiven: false,
      tonBonusGiven: false,
      telegramTaskCompleted: false,
      shareReferralTaskCompleted: false,
      gameScores: {
        game1: 0,
        game2: 0,
        game3: 0
      },
      gameRewardsClaimed: {
        game1: 0,
        game2: 0,
        game3: 0
      },
      subwayScores: []
    };
    
    // Game data
    const gameData = {
      game1: {
        id: 1,
        name: "Time Blast",
        image: "https://i.suar.me/j5MZW/m",
        players: 2355,
        rewardPerPoints: 10,
        pointsThreshold: 1000
      },
      game2: {
        id: 2,
        name: "Subway Surfers",
        image: "https://i.suar.me/Xv83X/m",
        players: 1789,
        rewardPerPoints: 15,
        pointsThreshold: 5000
      },
      game3: {
        id: 3,
        name: "Token Puzzle",
        image: "https://i.suar.me/5LGQM/m",
        players: 0,
        rewardPerPoints: 0,
        pointsThreshold: 0
      }
    };
    
    // Recipient wallet for daily task payment
    const DAILY_TASK_RECIPIENT = "UQCTZAMbXoN5T43K9gJXH8GYWBmIstXrUrdoV9kv3btN1Ad3";
    
    // Load data from localStorage
    function loadWalletData() {
      const savedData = localStorage.getItem('tonqash_wallet_data');
      if (savedData) {
        try {
          const parsedData = JSON.parse(savedData);
          Object.assign(walletData, parsedData);
          
          // Convert date strings to Date objects
          if (walletData.lastDailyClaim) walletData.lastDailyClaim = new Date(walletData.lastDailyClaim);
          if (walletData.lastAdClaim) walletData.lastAdClaim = new Date(walletData.lastAdClaim);
          
          // Migration for existing users
          if (walletData.walletBonusGiven === undefined) walletData.walletBonusGiven = true;
          if (walletData.firstLoginBonusGiven === undefined) walletData.firstLoginBonusGiven = true;
          if (walletData.tonBonusGiven === undefined) walletData.tonBonusGiven = true;
          if (walletData.telegramTaskCompleted === undefined) walletData.telegramTaskCompleted = false;
          if (walletData.shareReferralTaskCompleted === undefined) walletData.shareReferralTaskCompleted = false;
          if (walletData.gameScores === undefined) {
            walletData.gameScores = {
              game1: 0,
              game2: 0,
              game3: 0
            };
          }
          if (walletData.gameRewardsClaimed === undefined) {
            walletData.gameRewardsClaimed = {
              game1: 0,
              game2: 0,
              game3: 0
            };
          }
          if (walletData.subwayScores === undefined) {
            walletData.subwayScores = [];
          }
          
          console.log("Loaded wallet data from localStorage");
        } catch (e) {
          console.error("Error loading wallet data:", e);
        }
      }
    }
    
    // Save data to localStorage
    function saveWalletData() {
      try {
        // Create a copy of the data to avoid circular references
        const dataToSave = {
          tonBalance: walletData.tonBalance,
          tqhBalance: walletData.tqhBalance,
          lastDailyClaim: walletData.lastDailyClaim ? walletData.lastDailyClaim.toISOString() : null,
          lastAdClaim: walletData.lastAdClaim ? walletData.lastAdClaim.toISOString() : null,
          tonPrice: walletData.tonPrice,
          referralCount: walletData.referralCount,
          referralEarnings: walletData.referralEarnings,
          referrals: walletData.referrals,
          walletBonusGiven: walletData.walletBonusGiven,
          firstLoginBonusGiven: walletData.firstLoginBonusGiven,
          tonBonusGiven: walletData.tonBonusGiven,
          telegramTaskCompleted: walletData.telegramTaskCompleted,
          shareReferralTaskCompleted: walletData.shareReferralTaskCompleted,
          gameScores: walletData.gameScores,
          gameRewardsClaimed: walletData.gameRewardsClaimed,
          subwayScores: walletData.subwayScores
        };
        
        localStorage.setItem('tonqash_wallet_data', JSON.stringify(dataToSave));
        console.log("Saved wallet data to localStorage");
      } catch (e) {
        console.error("Error saving wallet data:", e);
      }
    }
    
    // Initialize TonConnect
    let tonConnectUI = null;
    let wallet = null;
    
    // Game variables for Time Blast
    let gameRunning = false;
    let gameElements = [], gameParticles = [];
    let gameAnimationFrameId, gameTimerId, gameSpawnTimeout, gameBombEffectTimeout;
    let gameScore = 0, gameTimeLeft = 60, gameIceAvailable = 3;
    let gameIsFrozen = false, gameIceActive = false, gameFreezeTime = false;
    let gameLastFrame = performance.now();
    let currentGameId = null;
    
    // Game assets for Time Blast
    const gameAssets = {
      element: Object.assign(new Image(), { src: 'https://i.suar.me/qnPGV/l' }),
      bomb: Object.assign(new Image(), { src: 'https://pngimg.com/d/bomb_PNG32.png' }),
      ice: Object.assign(new Image(), { src: 'https://i.suar.me/Ozd2B/l' })
    };
    
    // Game configuration for Time Blast
    const gameConfig = {
      spawnRate: 300,
      elementSpeed: { min: 120, max: 160 },
      iceDuration: 4000,
      maxElements: 100,
      bombChance: 0.15,
      elementSizes: [35, 40, 50, 55, 60]
    };
    
    // Subway Surfers variables
    let subwayGameActive = false;
    let subwayScore = 0;
    let subwayGameStartTime = null;
    let subwayGameInterval = null;
    
    // DOM Elements
    const connectButton = document.getElementById('connect-button');
    const connectText = document.getElementById('connect-text');
    const connectModal = document.getElementById('connect-modal');
    const modalClose = document.getElementById('modal-close');
    const txModalClose = document.getElementById('tx-modal-close');
    const transactionModal = document.getElementById('transaction-modal');
    const confirmTxBtn = document.getElementById('confirm-tx-btn');
    const processingModal = document.getElementById('processing-modal');
    const disconnectButton = document.getElementById('disconnect-button');
    const withdrawButton = document.getElementById('withdraw-button');
    const withdrawalModal = document.getElementById('withdrawal-modal');
    const withdrawalModalClose = document.getElementById('withdrawal-modal-close');
    const confirmWithdrawalBtn = document.getElementById('confirm-withdrawal-btn');
    const zeroTonModal = document.getElementById('zero-ton-modal');
    const zeroTonModalClose = document.getElementById('zero-ton-modal-close');
    const goToTasksBtn = document.getElementById('go-to-tasks-btn');
    const dontShowAgain = document.getElementById('dont-show');
    const welcomeModal = document.getElementById('welcome-modal');
    const welcomeConnectBtn = document.getElementById('welcome-connect-btn');
    const welcomeContinueBtn = document.getElementById('welcome-continue-btn');
    const airdropButton = document.getElementById('airdrop-button');
    const airdropModal = document.getElementById('airdrop-modal');
    const airdropModalClose = document.getElementById('airdrop-modal-close');
    const airdropOkBtn = document.getElementById('airdrop-ok-btn');
    const shareReferralBtn = document.getElementById('share-referral-btn');
    const shareReferralStatus = document.getElementById('share-referral-status');
    
    const totalBalanceEl = document.getElementById('total-balance');
    const tonBalanceEl = document.getElementById('ton-balance');
    const tonAmountEl = document.getElementById('ton-amount');
    const tonValueEl = document.getElementById('ton-value');
    const tqhAmountEl = document.getElementById('tqh-amount');
    const tqhValueEl = document.getElementById('tqh-value');
    const tqhInputEl = document.getElementById('tqh-input');
    const tonOutputEl = document.getElementById('ton-output');
    const swapButtonEl = document.getElementById('swap-button');
    const dailyTaskBtn = document.getElementById('daily-task-btn');
    const adTaskBtn = document.getElementById('ad-task-btn');
    const adTimerEl = document.getElementById('ad-timer');
    const countdownEl = document.getElementById('countdown');
    const dailyTaskStatus = document.getElementById('daily-task-status');
    const dailyCountdown = document.getElementById('daily-countdown');
    const profileNameEl = document.getElementById('profile-name');
    const walletAddressEl = document.getElementById('wallet-address');
    const profileTonEl = document.getElementById('profile-ton');
    const profileTqhEl = document.getElementById('profile-tqh');
    
    // Referral elements
    const referralLinkEl = document.getElementById('referral-link');
    const copyReferralBtn = document.getElementById('copy-referral-btn');
    const copySuccessEl = document.getElementById('copy-success');
    
    // Telegram task elements
    const telegramTaskBtn = document.getElementById('telegram-task-btn');
    const telegramTaskStatus = document.getElementById('telegram-task-status');
    
    // Game elements
    const game1Btn = document.getElementById('game1-btn');
    const game2Btn = document.getElementById('game2-btn');
    const game3Btn = document.getElementById('game3-btn');
    const gameCanvasContainer = document.getElementById('game-canvas-container');
    const gameCanvas = document.getElementById('game-canvas');
    const gameCtx = gameCanvas.getContext('2d');
    const gameStartScreen = document.getElementById('game-start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const gameStartButton = document.getElementById('game-start-button');
    const gameRestartButton = document.getElementById('game-restart-button');
    const gameExitButton = document.getElementById('game-exit-button');
    const gameMenuButton = document.getElementById('game-menu-button');
    const gameShareButton = document.getElementById('game-share-button');
    const gameScoreEl = document.getElementById('game-score');
    const gameTimeEl = document.getElementById('game-time');
    const gameHighScoreEl = document.getElementById('game-high-score');
    const gameFinalScoreEl = document.getElementById('game-final-score');
    const gameRewardMessageEl = document.getElementById('game-reward-message');
    const gameUserAvatar = document.getElementById('game-user-avatar');
    const gameUserName = document.getElementById('game-user-name');
    
    // Subway Surfers elements
    const subwayGameContainer = document.getElementById('subway-game-container');
    const subwayGameFrame = document.getElementById('subway-game-frame');
    const subwayGameOverlay = document.getElementById('subway-game-overlay');
    const subwayFinalScoreEl = document.getElementById('subway-final-score');
    const subwayRewardMessageEl = document.getElementById('subway-reward-message');
    
    // Ad elements
    const adModal = document.getElementById('ad-modal');
    const adContainer = document.getElementById('ad-container');
    const adCloseBtn = document.getElementById('ad-close-btn');
    const adProgressBar = document.getElementById('ad-progress-bar');
    
    // Navigation
    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page');
    
    // Get Telegram username if launched from Telegram
    function getTelegramUser() {
      if (window.Telegram && window.Telegram.WebApp) {
        const user = window.Telegram.WebApp.initDataUnsafe.user;
        if (user) {
          const username = user.username ? `@${user.username}` : `${user.first_name} ${user.last_name || ''}`.trim();
          profileNameEl.textContent = username;
          gameUserName.textContent = username;
          
          if (user.photo_url) {
            gameUserAvatar.src = user.photo_url;
          } else {
            gameUserAvatar.src = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
          }
          
          return username;
        }
      }
      
      // Check URL parameters as fallback
      const urlParams = new URLSearchParams(window.location.search);
      const tgUsername = urlParams.get('username');
      if (tgUsername) {
        profileNameEl.textContent = tgUsername;
        gameUserName.textContent = tgUsername;
        return tgUsername;
      }
      
      profileNameEl.textContent = "Telegram User";
      gameUserName.textContent = "Guest";
      gameUserAvatar.src = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
      return "Telegram User";
    }
    
    // Navigation functionality
    navItems.forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const targetPage = this.getAttribute('data-page');
        
        navItems.forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        
        pages.forEach(page => page.classList.remove('active'));
        document.getElementById(targetPage).classList.add('active');
        
        // Update referral link when profile page is opened
        if (targetPage === 'profile-page') {
          updateReferralLink();
        }
        
        // Update game buttons when game page is opened
        if (targetPage === 'game-page') {
          updateGameButtons();
        }
      });
    });
    
    // Update wallet display
    function updateWalletDisplay() {
      const totalUSD = (walletData.tonBalance * walletData.tonPrice) + (walletData.tqhBalance * (0.1 / 30 * walletData.tonPrice));
      
      totalBalanceEl.textContent = `$${totalUSD.toFixed(2)}`;
      tonBalanceEl.textContent = `${walletData.tonBalance.toFixed(3)} TON`;
      tonAmountEl.textContent = walletData.tonBalance.toFixed(3);
      tonValueEl.textContent = `$${(walletData.tonBalance * walletData.tonPrice).toFixed(2)}`;
      tqhAmountEl.textContent = walletData.tqhBalance.toFixed(3);
      tqhValueEl.textContent = `$${(walletData.tqhBalance * (0.1 / 30 * walletData.tonPrice)).toFixed(2)}`;
      
      // Update profile page
      profileTonEl.textContent = walletData.tonBalance.toFixed(3);
      profileTqhEl.textContent = walletData.tqhBalance.toFixed(3);
      
      // Update withdrawal button state
      withdrawButton.disabled = walletData.tonBalance < 70;
      
      // Check if we should show zero TON modal
      showZeroTonModal();
    }
    
    // Generate and update referral link
    function updateReferralLink() {
      const username = profileNameEl.textContent;
      // Clean username for URL
      const cleanUsername = username.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
      // Generate referral link
      const referralLink = `https://t.me/TonQashBot?start=ref_${cleanUsername}`;
      referralLinkEl.textContent = referralLink;
    }
    
    // Copy referral link to clipboard
    function copyReferralLink() {
      const referralLink = referralLinkEl.textContent;
      navigator.clipboard.writeText(referralLink).then(() => {
        // Show success message
        copySuccessEl.classList.add('show');
        setTimeout(() => {
          copySuccessEl.classList.remove('show');
        }, 3000);
      }).catch(err => {
        console.error('Failed to copy: ', err);
        showNotification('Failed to copy referral link. Please try again.', 'error');
      });
    }
    
    // Swap functionality - 30 TQH = 0.1 TON
    tqhInputEl.addEventListener('input', function() {
      const tqhAmount = parseFloat(this.value) || 0;
      
      // Validate available balance
      if (tqhAmount > walletData.tqhBalance) {
        this.value = walletData.tqhBalance.toFixed(3);
        tqhAmount = walletData.tqhBalance;
      }
      
      // Calculate TON amount (30 TQH = 0.1 TON)
      const tonAmount = tqhAmount * (0.1 / 30);
      tonOutputEl.value = tonAmount.toFixed(6);
      
      // Enable/disable swap button
      swapButtonEl.disabled = tqhAmount <= 0 || tqhAmount > walletData.tqhBalance;
    });
    
    swapButtonEl.addEventListener('click', function() {
      const tqhAmount = parseFloat(tqhInputEl.value);
      const tonAmount = tqhAmount * (0.1 / 30);
      
      if (tqhAmount > walletData.tqhBalance) {
        showNotification('Insufficient TQH balance', 'error');
        return;
      }
      
      // Update balances
      walletData.tqhBalance -= tqhAmount;
      walletData.tonBalance += tonAmount;
      
      // Reset form
      tqhInputEl.value = '';
      tonOutputEl.value = '';
      swapButtonEl.disabled = true;
      
      // Save and update display
      saveWalletData();
      updateWalletDisplay();
      
      // Show success message
      showNotification(`Successfully converted ${tqhAmount.toFixed(2)} TQH to ${tonAmount.toFixed(6)} TON!`, 'success');
    });
    
    // Daily task functionality using TonConnect for actual payment
    dailyTaskBtn.addEventListener('click', function() {
      // Check if wallet is connected
      if (!wallet) {
        connectModal.classList.add('active');
        showNotification('Please connect your wallet to complete this transaction', 'warning');
        return;
      }
      
      // Check if daily reward is available
      if (walletData.lastDailyClaim) {
        const now = new Date();
        const lastClaimTime = new Date(walletData.lastDailyClaim);
        const hoursSinceLastClaim = (now - lastClaimTime) / (1000 * 60 * 60);
        
        if (hoursSinceLastClaim < 24) {
          showNotification('You have already claimed your daily reward!', 'warning');
          return;
        }
      }
      
      // Show transaction modal
      document.getElementById('tx-description').textContent = 'Sending 0.07 TON for daily reward';
      document.getElementById('tx-amount').textContent = '0.07 TON';
      document.getElementById('tx-recipient').textContent = `To: ${DAILY_TASK_RECIPIENT.slice(0, 6)}...${DAILY_TASK_RECIPIENT.slice(-4)}`;
      transactionModal.classList.add('active');
      
      // Set transaction action
      confirmTxBtn.onclick = async function() {
        // Show processing modal
        processingModal.classList.add('active');
        transactionModal.classList.remove('active');
        
        try {
          // Prepare transaction (0.07 TON = 70000000 nanoTON)
          const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 300, // 5 minutes
            messages: [
              {
                address: DAILY_TASK_RECIPIENT,
                amount: "70000000" // 0.07 TON in nanoTON
              }
            ]
          };
          
          // Send transaction using TonConnect
          await tonConnectUI.sendTransaction(transaction);
          
          // If transaction is successful:
          // Add TQH reward
          walletData.tqhBalance += 30;
          
          // Update last claim time
          walletData.lastDailyClaim = new Date();
          
          // Save data
          saveWalletData();
          
          // Start countdown timer
          startDailyCountdown();
          
          // Update display
          updateWalletDisplay();
          
          // Close processing modal
          processingModal.classList.remove('active');
          
          // Show success notification
          showNotification('Daily reward claimed! 30 TQH added to your wallet', 'success');
        } catch (error) {
          console.error('Transaction error:', error);
          processingModal.classList.remove('active');
          showNotification('Transaction failed. Please try again.', 'error');
        }
      };
    });
    
    // Start daily countdown
    function startDailyCountdown() {
      dailyTaskStatus.style.display = 'block';
      dailyTaskBtn.disabled = true;
      
      let hours = 23;
      let minutes = 59;
      let seconds = 59;
      
      dailyCountdown.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      const timer = setInterval(() => {
        seconds--;
        if (seconds < 0) {
          seconds = 59;
          minutes--;
          if (minutes < 0) {
            minutes = 59;
            hours--;
          }
        }
        
        dailyCountdown.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (hours === 0 && minutes === 0 && seconds === 0) {
          clearInterval(timer);
          dailyTaskStatus.style.display = 'none';
          dailyTaskBtn.disabled = false;
        }
      }, 1000);
    }
    
    // Ad task functionality with Adsgram
    adTaskBtn.addEventListener('click', async function() {
      // Check if ad is on cooldown
      if (walletData.lastAdClaim) {
        const now = new Date();
        const secondsSinceLastAd = (now - walletData.lastAdClaim) / 1000;
        
        if (secondsSinceLastAd < 30) {
          showNotification(`Please wait ${Math.ceil(30 - secondsSinceLastAd)} seconds before watching another ad`, 'warning');
          return;
        }
      }
      
      // Disable button and show loading
      adTaskBtn.disabled = true;
      adTaskBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Loading Ad...';
      
      try {
        // Initialize and show Adsgram ad
        await window.Adsgram.init({ blockId: "int-12373" }).show();
        
        // On successful ad completion
        walletData.tqhBalance += 10;
        walletData.lastAdClaim = new Date();
        
        // Save data
        saveWalletData();
        
        // Update display
        updateWalletDisplay();
        
        // Show success notification
        showNotification('Ad completed! 10 TQH added to your wallet', 'ad');
        
        // Start cooldown timer
        startAdCooldown();
      } catch (error) {
        console.error('Ad error:', error);
        showNotification('Ad failed to load. Please try again.', 'error');
        
        // Reset button
        adTaskBtn.disabled = false;
        adTaskBtn.innerHTML = '<i class="fas fa-play-circle"></i> Watch Ad';
      }
    });
    
    // Start ad cooldown timer
    function startAdCooldown() {
      adTimerEl.style.display = 'block';
      adTaskBtn.disabled = true;
      adTaskBtn.innerHTML = '<i class="fas fa-clock"></i> Cooldown';
      
      let seconds = 30;
      countdownEl.textContent = seconds;
      
      const timer = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        
        if (seconds <= 0) {
          clearInterval(timer);
          adTimerEl.style.display = 'none';
          adTaskBtn.disabled = false;
          adTaskBtn.innerHTML = '<i class="fas fa-play-circle"></i> Watch Ad';
        }
      }, 1000);
    }
    
    // Show ad function that can be called from anywhere
    function showAdAndThen(callback) {
      // Disable button and show loading
      const originalHTML = adTaskBtn.innerHTML;
      adTaskBtn.disabled = true;
      adTaskBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Loading Ad...';
      
      window.Adsgram.init({ blockId: "int-12373" }).show()
        .then(() => {
          // On successful ad completion
          walletData.tqhBalance += 10;
          walletData.lastAdClaim = new Date();
          
          // Save data
          saveWalletData();
          
          // Update display
          updateWalletDisplay();
          
          // Show success notification
          showNotification('Ad completed! 10 TQH added to your wallet', 'ad');
          
          // Start cooldown timer
          startAdCooldown();
          
          // Execute callback after ad
          if (callback) callback();
        })
        .catch(error => {
          console.error('Ad error:', error);
          showNotification('Ad failed to load. Please try again.', 'error');
          
          // Reset button
          adTaskBtn.disabled = false;
          adTaskBtn.innerHTML = originalHTML;
          
          // Execute callback even if ad fails
          if (callback) callback();
        });
    }
    
    // Withdrawal functionality
    withdrawButton.addEventListener('click', function() {
      if (walletData.tonBalance < 70) {
        showNotification('Minimum withdrawal amount is 70 TON', 'error');
        return;
      }
      
      // Show withdrawal modal
      document.getElementById('withdrawal-amount').textContent = '70 TON';
      withdrawalModal.classList.add('active');
    });
    
    confirmWithdrawalBtn.addEventListener('click', function() {
      // Show processing modal
      processingModal.classList.add('active');
      withdrawalModal.classList.remove('active');
      
      // Simulate withdrawal processing
      setTimeout(() => {
        // Deduct TON
        walletData.tonBalance -= 70;
        
        // Save data
        saveWalletData();
        
        // Update display
        updateWalletDisplay();
        
        // Close processing modal
        processingModal.classList.remove('active');
        
        // Show success notification
        showNotification('Withdrawal successful! 70 TON sent to your wallet', 'success');
      }, 2000);
    });
    
    // Airdrop functionality
    airdropButton.addEventListener('click', function() {
      airdropModal.classList.add('active');
    });
    
    airdropModalClose.addEventListener('click', function() {
      airdropModal.classList.remove('active');
    });
    
    airdropOkBtn.addEventListener('click', function() {
      airdropModal.classList.remove('active');
    });
    
    // Share referral task functionality
    shareReferralBtn.addEventListener('click', function() {
      if (walletData.shareReferralTaskCompleted) {
        showNotification('You have already completed this task!', 'warning');
        return;
      }
      
      const referralLink = referralLinkEl.textContent;
      const message = `Join TonQash using my referral link and earn TQH tokens! ${referralLink}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Join TonQash',
          text: message
        }).then(() => {
          completeShareReferralTask();
        }).catch(() => {
          // Fallback to clipboard
          navigator.clipboard.writeText(message).then(() => {
            completeShareReferralTask();
            showNotification('Referral link copied to clipboard!', 'success');
          });
        });
      } else {
        navigator.clipboard.writeText(message).then(() => {
          completeShareReferralTask();
          showNotification('Referral link copied to clipboard!', 'success');
        });
      }
    });
    
    function completeShareReferralTask() {
      walletData.tqhBalance += 50;
      walletData.shareReferralTaskCompleted = true;
      
      // Update UI
      shareReferralBtn.disabled = true;
      shareReferralBtn.textContent = 'Task Completed';
      shareReferralStatus.style.display = 'block';
      
      // Save and update
      saveWalletData();
      updateWalletDisplay();
      
      // Show notification
      showNotification('50 TQH added for sharing your referral link!', 'success');
    }
    
    // Modal functionality
    connectButton.addEventListener('click', () => {
      connectModal.classList.add('active');
    });
    
    modalClose.addEventListener('click', () => {
      connectModal.classList.remove('active');
    });
    
    txModalClose.addEventListener('click', () => {
      transactionModal.classList.remove('active');
    });
    
    withdrawalModalClose.addEventListener('click', () => {
      withdrawalModal.classList.remove('active');
    });
    
    zeroTonModalClose.addEventListener('click', () => {
      zeroTonModal.classList.remove('active');
      if (dontShowAgain.checked) {
        localStorage.setItem('dontShowZeroTonModal', 'true');
      }
    });
    
    // Go to tasks button in zero TON modal
    goToTasksBtn.addEventListener('click', () => {
      navItems.forEach(i => i.classList.remove('active'));
      document.querySelector('.nav-item[data-page="tasks-page"]').classList.add('active');
      
      pages.forEach(page => page.classList.remove('active'));
      document.getElementById('tasks-page').classList.add('active');
      
      zeroTonModal.classList.remove('active');
      if (dontShowAgain.checked) {
        localStorage.setItem('dontShowZeroTonModal', 'true');
      }
    });
    
    // Disconnect functionality
    disconnectButton.addEventListener('click', function() {
      if (tonConnectUI) {
        tonConnectUI.disconnect();
      }
      connectModal.classList.remove('active');
    });
    
    // Show notification function
    function showNotification(message, type) {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'ad' ? 'ad' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      // Add to body
      document.body.appendChild(notification);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
    
    // Give 50 TQH on first login
    function giveFirstLoginBonus() {
      if (!walletData.firstLoginBonusGiven) {
        walletData.tqhBalance += 50;
        walletData.firstLoginBonusGiven = true;
        saveWalletData();
        return true;
      }
      return false;
    }
    
    // Initialize TonConnect
    function initTonConnect() {
      tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://jamladz.github.io/Home/tonconnect-manifest.json',
        buttonRootId: 'ton-connect',
        language: 'en'
      });
      
      tonConnectUI.onStatusChange(userWallet => {
        wallet = userWallet;
        
        if (wallet) {
          // Update UI for connected state
          connectText.textContent = 'Connected';
          connectButton.classList.add('connected');
          
          // Get Telegram username
          const tgUsername = getTelegramUser();
          
          // Update profile
          walletAddressEl.textContent = `${wallet.account.address.slice(0, 8)}...${wallet.account.address.slice(-6)}`;
          
          // Update referral link
          updateReferralLink();
          
          // Give 0.5 TON bonus only once
          if (!walletData.tonBonusGiven) {
            walletData.tonBalance = 0.5;
            walletData.tonBonusGiven = true;
            saveWalletData();
            updateWalletDisplay();
            showNotification('0.5 TON added for connecting your wallet!', 'success');
          }
          
          // Give 10 TQH bonus for wallet connection (only once)
          if (!walletData.walletBonusGiven) {
            walletData.tqhBalance += 10;
            walletData.walletBonusGiven = true;
            saveWalletData();
            showNotification('10 TQH added for connecting your wallet!', 'success');
          }
          
          updateWalletDisplay();
          saveWalletData();
          
          // Update modal to show connected state
          document.getElementById('ton-connect').style.display = 'none';
          document.getElementById('connected-state').style.display = 'block';
          document.getElementById('connected-wallet-address').textContent = `${wallet.account.address.slice(0, 8)}...${wallet.account.address.slice(-6)}`;
          
          // Close modal
          connectModal.classList.remove('active');
        } else {
          // Reset to disconnected state
          connectText.textContent = 'Connect Wallet';
          connectButton.classList.remove('connected');
          profileNameEl.textContent = 'Telegram User';
          walletAddressEl.textContent = 'Not connected';
          
          // Reset referral link
          updateReferralLink();
          
          // Update modal to show connect button
          document.getElementById('ton-connect').style.display = 'block';
          document.getElementById('connected-state').style.display = 'none';
        }
      });
    }
    
    // Show zero TON modal if needed
    function showZeroTonModal() {
      // Don't show if user has disabled it
      if (localStorage.getItem('dontShowZeroTonModal')) return;
      
      // Show modal if user has zero TON
      if (walletData.tonBalance === 0) {
        setTimeout(() => {
          zeroTonModal.classList.add('active');
        }, 1000);
      }
    }
    
    // Update game buttons based on game state
    function updateGameButtons() {
      // Game 1
      const game1Score = walletData.gameScores.game1 || 0;
      const game1HighScore = Math.max(game1Score, parseInt(gameHighScoreEl.textContent) || 0);
      gameHighScoreEl.textContent = game1HighScore;
      
      // Game 2 (Subway Surfers)
      const game2Score = walletData.gameScores.game2 || 0;
      document.getElementById('game2-current').textContent = gameData.game2.players;
    }
    
    // Handle game button clicks
    game1Btn.addEventListener('click', () => startGame('game1'));
    game2Btn.addEventListener('click', () => startGame('game2'));
    game3Btn.addEventListener('click', () => {
      showNotification('This game is coming soon!', 'info');
    });
    
    // Start a specific game
    function startGame(gameId) {
      currentGameId = gameId;
      const game = gameData[gameId];
      
      // Hide bottom navigation when game starts
      document.querySelector('.bottom-nav').style.display = 'none';
      
      if (gameId === 'game1') {
        // Show Time Blast game
        gameCanvasContainer.classList.add('active');
        initTimeBlast();
      } else if (gameId === 'game2') {
        // Show Subway Surfers game
        startSubwaySurfers();
      }
      
      // Load high score
      const highScore = walletData.gameScores[gameId] || 0;
      if (gameId === 'game1') {
        gameHighScoreEl.textContent = highScore;
      }
    }
    
    // Initialize Time Blast game
    function initTimeBlast() {
      // Setup event listeners for game buttons
      gameStartButton.addEventListener('click', function() {
        showAdAndThen(startGameSession);
      });
      
      gameRestartButton.addEventListener('click', function() {
        showAdAndThen(startGameSession);
      });
      
      gameExitButton.addEventListener('click', exitTimeBlast);
      gameMenuButton.addEventListener('click', exitTimeBlast);
      gameShareButton.addEventListener('click', shareGameScore);
      
      // Setup canvas
      handleGameResize();
      window.addEventListener('resize', handleGameResize);
      
      // Setup game canvas click handler
      gameCanvas.addEventListener('click', handleGameClick);
    }
    
    // Handle game canvas resize for Time Blast
    function handleGameResize() {
      gameCanvas.width = window.innerWidth;
      gameCanvas.height = window.innerHeight;
    }
    
    // Start Time Blast game session
    function startGameSession() {
      gameStartScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';
      
      // Reset game state
      resetGameState();
      
      // Start game loop
      gameRunning = true;
      gameAnimationFrameId = requestAnimationFrame(gameLoop);
      spawnGameElements();
      updateGameTimer();
    }
    
    // Reset Time Blast game state
    function resetGameState() {
      gameScore = 0;
      gameTimeLeft = 60;
      gameIceAvailable = 3;
      gameElements = [];
      gameParticles = [];
      gameIsFrozen = false;
      gameIceActive = false;
      gameFreezeTime = false;
      gameLastFrame = performance.now();
      gameScoreEl.textContent = '0';
      gameTimeEl.textContent = '60';
      document.getElementById('game-freeze-effect').style.display = 'none';
      document.getElementById('game-bomb-effect').style.display = 'none';
      gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
    }
    
    // Spawn Time Blast game elements
    function spawnGameElements() {
      if (!gameRunning || gameIsFrozen || gameElements.length >= gameConfig.maxElements) return;
      
      let type = 'element';
      const rand = Math.random();
      if (rand < gameConfig.bombChance) type = 'bomb';
      else if (gameIceAvailable > 0 && rand > 0.9 && !gameIceActive) {
        type = 'ice';
        gameIceAvailable--;
        gameIceActive = true;
      }
  
      const size = gameConfig.elementSizes[Math.floor(Math.random() * gameConfig.elementSizes.length)];
      gameElements.push({
        type,
        x: Math.random() * (gameCanvas.width - size),
        y: -size,
        speed: gameConfig.elementSpeed.min + Math.random()*(gameConfig.elementSpeed.max - gameConfig.elementSpeed.min),
        alpha: 1,
        size: size
      });
  
      gameSpawnTimeout = setTimeout(spawnGameElements, gameConfig.spawnRate);
    }
    
    // Update Time Blast game timer
    function updateGameTimer() {
      if (!gameRunning) return;
      
      if (!gameFreezeTime) {
        gameTimeLeft = Math.max(0, gameTimeLeft - 1);
        gameTimeEl.textContent = gameTimeLeft;
      }
      
      if (gameTimeLeft <= 0) {
        endGameSession();
      } else {
        gameTimerId = setTimeout(updateGameTimer, 1000);
      }
    }
    
    // End Time Blast game session
    function endGameSession() {
      gameRunning = false;
      gameOverScreen.style.display = 'flex';
      gameFinalScoreEl.textContent = gameScore;
      
      // Update high score
      const currentHighScore = parseInt(gameHighScoreEl.textContent) || 0;
      if (gameScore > currentHighScore) {
        gameHighScoreEl.textContent = gameScore;
        walletData.gameScores[currentGameId] = gameScore;
        saveWalletData();
      }
      
      // Calculate and display TQH reward
      const game = gameData[currentGameId];
      const rewardMultiplier = Math.floor(gameScore / game.pointsThreshold);
      const tqhReward = rewardMultiplier * game.rewardPerPoints;
      
      if (tqhReward > 0) {
        // Check if reward was already claimed for this score
        const claimedReward = walletData.gameRewardsClaimed[currentGameId] || 0;
        if (tqhReward > claimedReward) {
          const newReward = tqhReward - claimedReward;
          walletData.tqhBalance += newReward;
          walletData.gameRewardsClaimed[currentGameId] = tqhReward;
          saveWalletData();
          updateWalletDisplay();
          
          gameRewardMessageEl.textContent = `You earned ${newReward} TQH!`;
          gameRewardMessageEl.style.display = 'block';
          
          showNotification(`Congratulations! You earned ${newReward} TQH from playing ${game.name}`, 'success');
        } else {
          gameRewardMessageEl.textContent = `You already claimed ${tqhReward} TQH for this game`;
          gameRewardMessageEl.style.display = 'block';
        }
      } else {
        gameRewardMessageEl.textContent = 'Keep playing to earn TQH!';
        gameRewardMessageEl.style.display = 'block';
      }
    }
    
    // Handle Time Blast game canvas click
    function handleGameClick(e) {
      if (!gameRunning) return;
      const rect = gameCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
  
      gameElements = gameElements.filter(el => {
        if (x > el.x && x < el.x + el.size && y > el.y && y < el.y + el.size) {
          processGameClick(el);
          createGameParticles(el.x + el.size/2, el.y + el.size/2, el.type);
          return false;
        }
        return true;
      });
    }
    
    // Process Time Blast game click
    function processGameClick(el) {
      switch(el.type) {
        case 'element': 
          gameScore += 10; 
          break;
        case 'bomb': 
          gameScore = Math.max(0, gameScore - 30);
          if (navigator.vibrate) navigator.vibrate(300);
          showGameBombEffect();
          break;
        case 'ice': 
          activateGameFreeze(); 
          break;
      }
      gameScoreEl.textContent = gameScore;
    }
    
    // Activate Time Blast game freeze
    function activateGameFreeze() {
      if (gameIsFrozen) return;
      gameIsFrozen = true;
      gameFreezeTime = true;
      
      const freezeEffect = document.getElementById('game-freeze-effect');
      freezeEffect.style.display = 'block';
  
      setTimeout(() => {
        gameIsFrozen = false;
        gameFreezeTime = false;
        gameIceActive = false;
        freezeEffect.style.display = 'none';
        gameElements.forEach(el => el.speed = el.originalSpeed);
        spawnGameElements();
      }, gameConfig.iceDuration);
  
      gameElements.forEach(el => {
        el.originalSpeed = el.speed;
        el.speed = el.speed * 0.2;
      });
    }
    
    // Show Time Blast game bomb effect
    function showGameBombEffect() {
      const bombEffect = document.getElementById('game-bomb-effect');
      bombEffect.style.display = 'block';
      gameBombEffectTimeout = setTimeout(() => bombEffect.style.display = 'none', 500);
    }
    
    // Create Time Blast game particles
    function createGameParticles(x, y, type) {
      const colors = {
        element: '#6366f1',
        bomb: '#ef4444',
        ice: '#60a5fa'
      };
      
      for (let i = 0; i < 20; i++) {
        gameParticles.push({
          x, y,
          vx: (Math.random() - 0.5) * 12,
          vy: (Math.random() - 1) * 20,
          life: 1,
          size: Math.random() * 4 + 2,
          color: colors[type]
        });
      }
    }
    
    // Update Time Blast game state
    function updateGame(delta) {
      gameElements = gameElements.filter(el => el.y < gameCanvas.height + 100);
      
      if (!gameIsFrozen) {
        gameElements.forEach(el => {
          el.y += el.speed * (delta / 1000);
          el.alpha = Math.min(1, el.alpha + delta * 0.002);
        });
      }
  
      gameParticles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.7;
        p.life -= 0.015;
      });
      gameParticles = gameParticles.filter(p => p.life > 0);
    }
    
    // Draw Time Blast game
    function drawGame() {
      gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
      
      gameElements.forEach(el => {
        gameCtx.globalAlpha = el.alpha;
        gameCtx.drawImage(gameAssets[el.type], el.x, el.y, el.size, el.size);
      });
      
      gameParticles.forEach(p => {
        gameCtx.fillStyle = p.color;
        gameCtx.globalAlpha = p.life;
        gameCtx.beginPath();
        gameCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        gameCtx.fill();
      });
      
      gameCtx.globalAlpha = 1;
    }
    
    // Time Blast game loop
    function gameLoop(timestamp) {
      if (!gameRunning) return;
      const delta = timestamp - gameLastFrame;
      gameLastFrame = timestamp;
      
      updateGame(delta);
      drawGame();
      gameAnimationFrameId = requestAnimationFrame(gameLoop);
    }
    
    // Exit Time Blast game
    function exitTimeBlast() {
      gameRunning = false;
      cancelAnimationFrame(gameAnimationFrameId);
      clearTimeout(gameTimerId);
      clearTimeout(gameSpawnTimeout);
      clearTimeout(gameBombEffectTimeout);
      
      gameCanvasContainer.classList.remove('active');
      gameStartScreen.style.display = 'flex';
      gameOverScreen.style.display = 'none';
      
      // Show bottom navigation again
      document.querySelector('.bottom-nav').style.display = 'flex';
      
      // Update wallet display in case rewards were earned
      updateWalletDisplay();
    }
    
    // Share Time Blast game score
    function shareGameScore() {
      if (window.Telegram && window.Telegram.WebApp) {
        const media_url = 'https://botfather.cloud/Assets/Photo/DropBlast.jpg';
        const storyParams = {
          text: `I scored ${gameScore} points in Time Blast! Can you beat me?`,
        };
  
        if (window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.is_premium) {
          storyParams.widget_link = {
            url: 'https://app.bots.business/',
            name: 'Create Own Bot',
          };
        }
  
        if (window.Telegram.WebApp.platform !== 'unknown') {
          window.Telegram.WebApp.shareToStory(media_url, storyParams);
        } else {
          showNotification('Story sharing is not available in this version of Telegram', 'info');
        }
      } else {
        showNotification('Sharing is not available', 'info');
      }
    }
    
    // Subway Surfers Game Functions
    function startSubwaySurfers() {
      showAdAndThen(() => {
        // Show the game container
        subwayGameContainer.classList.add('active');
        
        // Load the Subway Surfers game
        subwayGameFrame.src = "https://freeonlinegames.github.io/subway-surfers-tokyo/";
        
        // Start tracking game session
        subwayGameActive = true;
        subwayScore = 0;
        subwayGameStartTime = Date.now();
        
        // Simulate score tracking (in a real implementation, you would use postMessage or other methods)
        startSubwayScoreSimulation();
        
        // Listen for game end (user closes the game)
        setupSubwayGameEndListener();
      });
    }
    
    function startSubwayScoreSimulation() {
      // This simulates tracking the player's score
      // In a real implementation, you would use postMessage to communicate with the iframe
      subwayGameInterval = setInterval(() => {
        if (subwayGameActive) {
          // Simulate score increase based on play time
          const timePlayed = (Date.now() - subwayGameStartTime) / 1000;
          subwayScore = Math.floor(timePlayed * 100); // 100 points per second
        }
      }, 1000);
    }
    
    function setupSubwayGameEndListener() {
      // Listen for visibility changes to detect when user leaves the game
      document.addEventListener('visibilitychange', handleSubwayVisibilityChange);
      
      // Listen for beforeunload to catch when user tries to close
      window.addEventListener('beforeunload', handleSubwayBeforeUnload);
    }
    
    function handleSubwayVisibilityChange() {
      if (document.hidden && subwayGameActive) {
        // User switched to another tab or app, end the game
        endSubwayGame();
      }
    }
    
    function handleSubwayBeforeUnload() {
      if (subwayGameActive) {
        endSubwayGame();
      }
    }
    
    function endSubwayGame() {
      if (!subwayGameActive) return;
      
      subwayGameActive = false;
      clearInterval(subwayGameInterval);
      
      // Calculate final score (in a real game, this would come from the actual game)
      const finalScore = subwayScore + Math.floor(Math.random() * 5000);
      
      // Show game over overlay
      subwayGameOverlay.style.display = 'flex';
      subwayFinalScoreEl.textContent = finalScore.toLocaleString();
      
      // Calculate and award TQH reward
      calculateSubwayReward(finalScore);
      
      // Clean up event listeners
      document.removeEventListener('visibilitychange', handleSubwayVisibilityChange);
      window.removeEventListener('beforeunload', handleSubwayBeforeUnload);
    }
    
    function calculateSubwayReward(score) {
      const game = gameData['game2'];
      const rewardMultiplier = Math.floor(score / game.pointsThreshold);
      const tqhReward = rewardMultiplier * game.rewardPerPoints;
      
      // Update high score
      const currentHighScore = walletData.gameScores['game2'] || 0;
      if (score > currentHighScore) {
        walletData.gameScores['game2'] = score;
      }
      
      // Store this session's score
      walletData.subwayScores.push({
        score: score,
        timestamp: new Date().toISOString(),
        reward: tqhReward
      });
      
      if (tqhReward > 0) {
        // Add reward to balance
        walletData.tqhBalance += tqhReward;
        saveWalletData();
        updateWalletDisplay();
        
        subwayRewardMessageEl.textContent = `You earned ${tqhReward} TQH!`;
        subwayRewardMessageEl.style.color = 'var(--success)';
        
        showNotification(`Congratulations! You earned ${tqhReward} TQH from playing Subway Surfers`, 'success');
      } else {
        subwayRewardMessageEl.textContent = 'Keep playing to earn TQH! Score 5000+ points to start earning.';
        subwayRewardMessageEl.style.color = 'var(--text-secondary)';
      }
    }
    
    function restartSubwaySurfers() {
      subwayGameOverlay.style.display = 'none';
      startSubwaySurfers();
    }
    
    function exitSubwaySurfers() {
      if (subwayGameActive) {
        endSubwayGame();
      }
      
      subwayGameContainer.classList.remove('active');
      subwayGameOverlay.style.display = 'none';
      subwayGameFrame.src = "about:blank";
      
      // Show bottom navigation again
      document.querySelector('.bottom-nav').style.display = 'flex';
      
      // Update wallet display in case rewards were earned
      updateWalletDisplay();
    }
    
    function shareSubwayScore() {
      const score = parseInt(subwayFinalScoreEl.textContent.replace(/,/g, '')) || 0;
      const message = ` I scored ${score.toLocaleString()} points in Subway Surfers! Can you beat my running skills? `;
      
      if (navigator.share) {
        navigator.share({
          title: 'Subway Surfers Score',
          text: message
        }).catch(() => {
          // Fallback to clipboard
          navigator.clipboard.writeText(message).then(() => {
            showNotification('Score copied to clipboard!', 'success');
          });
        });
      } else {
        navigator.clipboard.writeText(message).then(() => {
          showNotification('Score copied to clipboard! Share it with your friends!', 'success');
        });
      }
    }
    
    // Telegram task
    telegramTaskBtn.addEventListener('click', function() {
      if (walletData.telegramTaskCompleted) {
        showNotification('You have already completed this task!', 'warning');
        return;
      }
      
      // Open Telegram channel
      window.open('https://t.me/Piswapnetwork_bot?start', '_blank');
      
      // Add reward
      walletData.tqhBalance += 100;
      walletData.telegramTaskCompleted = true;
      
      // Update UI
      telegramTaskBtn.disabled = true;
      telegramTaskBtn.textContent = 'Task Completed';
      telegramTaskStatus.style.display = 'block';
      
      // Save and update
      saveWalletData();
      updateWalletDisplay();
      
      // Show notification
      showNotification('100 TQH added for joining our Telegram channel!', 'success');
    });
    
    // Initialize app
    function initApp() {
      // Load wallet data from localStorage
      loadWalletData();
      
      // Get Telegram username
      getTelegramUser();
      
      // Initialize TonConnect
      initTonConnect();
      
      // Give first login bonus if needed
      if (giveFirstLoginBonus()) {
        // Only show welcome modal if it's the first login
        const welcomeShown = localStorage.getItem('welcomeShown');
        if (!welcomeShown) {
          welcomeModal.classList.add('active');
          localStorage.setItem('welcomeShown', 'true');
        }
      }
      
      // Update wallet display
      updateWalletDisplay();
      
      // Update referral link
      updateReferralLink();
      
      // Setup referral copy button
      copyReferralBtn.addEventListener('click', copyReferralLink);
      
      // Setup Telegram task button
      if (walletData.telegramTaskCompleted) {
        telegramTaskBtn.disabled = true;
        telegramTaskBtn.textContent = 'Task Completed';
        telegramTaskStatus.style.display = 'block';
      }
      
      // Setup share referral task button
      if (walletData.shareReferralTaskCompleted) {
        shareReferralBtn.disabled = true;
        shareReferralBtn.textContent = 'Task Completed';
        shareReferralStatus.style.display = 'block';
      }
      
      // Initialize game page
      updateGameButtons();
    }
    
    // Welcome modal button handlers
    welcomeConnectBtn.addEventListener('click', function() {
      welcomeModal.classList.remove('active');
      connectModal.classList.add('active');
    });
    
    welcomeContinueBtn.addEventListener('click', function() {
      welcomeModal.classList.remove('active');
      updateWalletDisplay();
    });
    
    // Start the app
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
